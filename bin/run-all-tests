set -e

echo "==============================="
echo "       COMPOSER VALIDATION"
echo "==============================="
composer validate composer.json

echo "==============================="
echo "          CODE TESTS"
echo "==============================="
vendor/bin/phpunit -c vendor/zoltan-hajdu/fs-php-sdk-pipelines/static/integrity/phpunit.xml --log-junit test-reports/junit.xml

if [[ -z "${UNIT_COVERAGE_THRESHOLD}" ]]; then
  UNIT_COVERAGE_THRESHOLD=70

echo "==============================="
echo "          UNIT TESTS"
echo "==============================="
vendor/bin/phpunit -c vendor/zoltan-hajdu/fs-php-sdk-pipelines/unit/phpunit.xml --log-junit test-reports/junit.xml --coverage-html test-coverage-html/ --coverage-clover clover.xml

echo "==============================="
echo "       UNIT TEST COVERAGE"
echo "==============================="
vendor/bin/coverage-check clover.xml $UNIT_COVERAGE_THRESHOLD